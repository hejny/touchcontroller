<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Sample of TC (ES6)</title>
        <link rel="stylesheet" type="text/css" href="./assets/common.css" />
    </head>
    <body>
        <canvas id="scene-background"></canvas>

        <div class="foreground">
            <canvas
                class="scene item"
                style="position: absolute; top: 0; left: 0"
                width="40"
                height="40"
            ></canvas>
            <canvas
                class="scene item"
                style="position: absolute; top: 0; left: 0"
                width="40"
                height="40"
            ></canvas>

            <svg
                data-playground='{"debug":true}'
                style="overflow: visible"
                width="500"
                height="500"
            >
                <g
                    transform="translate(4,4)"
                    data-playground='{"amount": 1, "interactions": [{"type": "drag"}], "anchors":{"donors": [{"type": "trains", "position": {"x":-15,"y":0}}], "acceptors": [{"type": "trains", "position": {"x":20,"y":0}, "accepts": 1, "parent": true}]}}'
                >
                    <rect
                        width="30"
                        height="30"
                        x="0"
                        y="0"
                        style="fill: white; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                </g>
                <g
                    transform="translate(4,44)"
                    data-playground='{"amount": 1, "interactions": [{"type": "drag"}], "anchors":{"donors": [{"type": "trains", "position": {"x":-30,"y":0}}], "acceptors": [{"type": "trains", "position": {"x":35,"y":0}, "accepts": 1, "parent": true}]}}'
                >
                    <rect
                        width="60"
                        height="30"
                        x="0"
                        y="0"
                        style="fill: #e42c1a; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                </g>
                <g
                    transform="translate(4,84)"
                    data-playground='{"amount": 1, "interactions": [{"type": "drag"}], "anchors":{"donors": [{"type": "trains", "position": {"x":-45,"y":0}}], "acceptors": [{"type": "trains", "position": {"x":50,"y":0}, "accepts": 1, "parent": true}]}}'
                >
                    <rect
                        width="90"
                        height="30"
                        x="0"
                        y="0"
                        style="fill: #43b94a; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                </g>
            </svg>

            <svg
                data-playground='{"interactions":[{"type": "draw"}]}'
                style="overflow: visible"
                width="500"
                height="500"
            >
                <g transform="translate(4,4)">
                    <rect
                        width="30"
                        height="30"
                        x="0"
                        y="15"
                        style="fill: #ff3820; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                    <polygon
                        points="0,15 0,15 15,0 45,0 45,0 30,15"
                        style="fill: #ff3820; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                    <polygon
                        points="45,0 45,0 30,15 30,45 30,45 45,30"
                        style="fill: #ff3820; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                </g>
                <g transform="translate(4,59)">
                    <rect
                        width="30"
                        height="30"
                        x="0"
                        y="15"
                        style="fill: #40cef6; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                    <polygon
                        points="0,15 0,15 15,0 45,0 45,0 30,15"
                        style="fill: #40cef6; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                    <polygon
                        points="45,0 45,0 30,15 30,45 30,45 45,30"
                        style="fill: #28a4d1; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                </g>
                <g transform="translate(4,114)">
                    <rect
                        width="30"
                        height="30"
                        x="0"
                        y="15"
                        style="fill: #43b94a; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                    <polygon
                        points="0,15 0,15 15,0 45,0 45,0 30,15"
                        style="fill: #58c05f; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                    <polygon
                        points="45,0 45,0 30,15 30,45 30,45 45,30"
                        style="fill: #39943b; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                </g>
                <g transform="translate(59,4)">
                    <rect
                        width="30"
                        height="30"
                        x="0"
                        y="15"
                        style="fill: #9ba2a6; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                    <polygon
                        points="0,15 0,15 15,0 45,0 45,0 30,15"
                        style="fill: #aeb5b9; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                    <polygon
                        points="45,0 45,0 30,15 30,45 30,45 45,30"
                        style="fill: #888e93; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                </g>
                <g transform="translate(59,59)">
                    <rect
                        width="30"
                        height="30"
                        x="0"
                        y="15"
                        style="fill: #ffea3d; stroke: #1a6aa3; stroke-width: 2"
                    ></rect>
                    <polygon
                        points="0,15 0,15 15,0 45,0 45,0 30,15"
                        style="fill: #ffea3d; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                    <polygon
                        points="45,0 45,0 30,15 30,45 30,45 45,30"
                        style="fill: #ffea3d; stroke: #1a6aa3; stroke-width: 2"
                    ></polygon>
                </g>
            </svg>
        </div>

        <script src="../dist/main.dev.browser.js"></script>
        <script src="/node_modules/xyzt/dist/main.browser.js"></script>
        <script>
            (() => {
                const {
                    TouchController,
                    MultiTouchController,
                    MultiTouchControllerDebugLayer,
                } = window.TouchController;
                const { BoundingBox, applyTransformOnSvgElement } = window.Xyzt;

                const dragElements = [
                    ...Array.from(document.querySelectorAll('.item')),
                    ...Array.from(document.querySelectorAll('svg > g')),
                ];

                const scene = document.getElementById('scene-background');
                scene.width = scene.getBoundingClientRect().width;
                scene.height = scene.getBoundingClientRect().height;
                const ctx = scene.getContext('2d');
                ctx.lineWidth = 10;
                ctx.lineCap = 'round';

                const touchController = new TouchController(
                    dragElements,
                    scene,
                );
                touchController.touches.subscribe((touch) => {
                    //console.log('touch',touch);

                    const color =
                        '#' + Math.floor(Math.random() * 16777215).toString(16);
                    let lastFrame = touch.firstFrame;

                    touch.frames.subscribe((frame) => {
                        //console.log('frame',frame);
                        //console.log('frame.position',frame.position);
                        //console.log('frame.positionRelative',frame.positionRelative);

                        ctx.strokeStyle = color;
                        ctx.beginPath();
                        ctx.moveTo(lastFrame.position.x, lastFrame.position.y);
                        ctx.lineTo(frame.position.x, frame.position.y);
                        ctx.stroke();
                        lastFrame = frame;
                    });
                });

                const multiTouchController = new MultiTouchController(
                    touchController,
                    (frame) => frame.element,
                );

                multiTouchController.hoveredElementsChanges.subscribe(
                    ({current, previous}) => {
                        if (current) {
                            elementNew.style.border = '2px solid yellow';
                        }
                        if (previous) {
                            elementOld.style.border = '2px solid black';
                        }
                    },
                );

                multiTouchController.multiTouches.subscribe((multitouch) => {
                    if (typeof multitouch.element === 'undefined') return;

                    multitouch.transforms.subscribe(
                        (transform) => {
                            applyTransformOnSvgElement(
                                transform,
                                multitouch.element,
                            );
                        },
                        () => {},
                        () => {
                            if (multitouch.empty) {
                                console.log(`You have selected element.`);
                            }
                        },
                    );
                });
            })();
        </script>
    </body>
</html>

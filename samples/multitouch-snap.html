<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sample of TC (ES6)</title>
</head>
<body>

<style>
    body{
        width:100vw;
        height:100vh;
        margin:0;
    }
    #scene{
        /*border: 1px solid red;*/
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
    }
</style>

<canvas id="scene" width="500" height="500"></canvas>


<script type="text/javascript" src="../dist/touchcontroller.browser.js"></script>
<script type="text/javascript">

    const TC = TouchController;
    const scene = document.getElementById('scene');

    scene.width = document.body.clientWidth;
    scene.height = document.body.clientHeight;

    const ctx = scene.getContext('2d');

    class Rect extends TC.BoundingBox {
        constructor(color, aceptor, center, size, rotation) {
            super(center,size,rotation);
            this.hovered = false;
            this.aceptor = aceptor;
            this.color = color;
        }

        render(ctx) {
            ctx.save();
            ctx.fillStyle = this.color;
            ctx.beginPath();

            ctx.rotate(this.rotation);
            ctx.translate(
                ...new TC.Vector2(
                        this.center.x,
                        this.center.y
                    )
                    .rotate(-this.rotation)
                .subtract(
                    new TC.Vector2(
                        this.size.x/2,
                        this.size.y/2
                    )
                )
                .toArray()
            );
            
            ctx.rect( 0,0, this.size.x,this.size.y);
            ctx.fill();

            /*{
                ctx.fillStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.rect( -5,-5, 10,10);
                ctx.fill();
                ctx.stroke();
            }*/


            if(this.hovered){
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            ctx.restore();
        }

        renderAnchors(ctx) {
            ctx.lineWidth = 1;
            {
                const size = 15;
                for(const point of this.anchorPoints.aceptors){
            
                    ctx.rect( point.x-size/2,point.y-size/2, size,size);//todo dynamic size
                    ctx.stroke();
                }
            }
            {
                const size = 10;
                for(const point of this.anchorPoints.donors){
            
                    ctx.rect( point.x-size/2,point.y-size/2, size,size);//todo dynamic size
                    ctx.stroke();
                }
            }
        }

        get anchorPoints(){

            const points = [
                this.center,
                this.center.add(),
                this.center.add(this.size.scale(0.5,0.5).rotate(this.rotation)),
                //this.center.add(this.size.scale(-.5,0.5).rotate(this.rotation)),
                //this.center.add(this.size.scale(0.5,-.5).rotate(this.rotation)),
                this.center.add(this.size.scale(-.5,-.5).rotate(this.rotation)),


            ];

            let aceptors = [];
            let donors = [];

            if(this.aceptor){
                aceptors = points;
             }else{
                donors = points;
            }
            
            return({
                aceptors,
                donors
            });

        }
    }

    const rects = [
        new Rect(
            'aqua',
            false,
            new TC.Vector2(100, 100),
            new TC.Vector2(100, 100),
            Math.PI / 10
        ),/**/
        new Rect(
            'aqua',
            false,
            new TC.Vector2(130, 130),
            new TC.Vector2(100, 100),
            Math.PI / -10
        ),/**/
        new Rect(
            'green',
            true,
            new TC.Vector2(300, 300),
            new TC.Vector2(200, 200),
            0
        )
    ];


    function render() {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        for (const rect of rects.slice().reverse()) {
            rect.render(ctx);
        }
        for (const rect of rects) {
            rect.renderAnchors(ctx);
        }
        requestAnimationFrame(render);
    }
    render();


    const touchController = new TC.TouchController(scene);
    const multiTouchController = new TC.MultiTouchController(
        touchController,
        (position)=>rects.find((rect) => rect.intersects(position))
    );



    //console.log(multiTouchController);
    multiTouchController.hoveredElementsChanges.subscribe(([elementNew,elementOld])=>{
        //console.log([elementNew,elementOld]);
        if(elementNew||false){
            elementNew.hovered = true;
        }
        if(elementOld||false){
            elementOld.hovered = false;
        }
    });


    multiTouchController.multiTouches.subscribe(function (multitouch) {

        if(typeof multitouch.element === 'undefined')return;
        const rect = multitouch.element;
        const sizeRatio = rect.size.y / rect.size.x;
        multitouch.transformations(
            /*new TC.Transformation(
                rect.center,
                rect.rotation,
                rect.size.x
            )*/
            multitouch.element
        ).subscribe(function (transformation) {

                //console.log(transformation);

                /*multitouch.element.center = transformation.translate;
                multitouch.element.rotation = transformation.rotate;
                multitouch.element.size.x = transformation.scale;
                multitouch.element.size.y = transformation.scale * sizeRatio;*/

                //multitouch.element.position = multitouch.element.position.add(transformation.translate);


            },
            function () {
            },
            function () {
                if(multitouch.empty){

                    //alert(`You have selected ${multitouch.element.color} rectangle.`);
                    rect.rotation += (Math.PI*2)/36;
                }
            });
    });
</script>


</body>
</html>